import time
import requests
import yaml
from zapv2 import ZAPv2

def zap_scan(target, config_file):
    with open(config_file, 'r') as f:
        config = yaml.safe_load(f)
    
    zap = ZAPv2(apikey=config['api_key'], proxies={'http': config['proxy'], 'https': config['proxy']})
    
    zap.urlopen(target)
    time.sleep(2)
    
    zap.spider.scan(target)
    time.sleep(10)
    while int(zap.spider.status()) < 100:
        print(f'Spider progress: {zap.spider.status()}%')
        time.sleep(5)
    
    zap.ascan.scan(target)
    while int(zap.ascan.status()) < 100:
        print(f'Active Scan progress: {zap.ascan.status()}%')
        time.sleep(5)
    
    return zap.core.htmlreport()

def save_report(report, output_file):
    with open(output_file, 'w') as f:
        f.write(report)

if __name__ == "__main__":
    target = "http://example.com"  # replace with the actual target
    report = zap_scan(target, 'config/zap_config.yaml')
    save_report(report, 'reports/zap_report.html')
